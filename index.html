<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>TCJH Volleyball Team</title>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
Â  Â  <style>
Â  Â  Â  Â  :root {Â 
Â  Â  Â  Â  Â  Â  --primary: #1a365d; --secondary: #2b6cb0; --accent: #f6ad55;
Â  Â  Â  Â  Â  Â  --danger: #e53e3e; --bg: #f7fafc; --white: #ffffff; --gray: #718096;
Â  Â  Â  Â  Â  Â  /* æ–°å¢æŠ•ç¥¨å°ˆç”¨è‰² */
Â  Â  Â  Â  Â  Â  --vote-bg: #feebc8; --vote-text: #9c4221;
Â  Â  Â  Â  }
Â  Â  Â  Â  * {Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  -webkit-tap-highlight-color: transparent;
Â  Â  Â  Â  }
Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  font-family: 'Noto Sans TC', "PingFang TC", "Microsoft JhengHei", sans-serif;Â 
Â  Â  Â  Â  Â  Â  background: var(--bg);Â 
Â  Â  Â  Â  Â  Â  margin: 0;Â 
Â  Â  Â  Â  Â  Â  color: var(--primary);
Â  Â  Â  Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  Â  Â  Â  Â  -moz-osx-font-smoothing: grayscale;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  header {Â 
Â  Â  Â  Â  Â  Â  background: var(--primary);Â 
Â  Â  Â  Â  Â  Â  color: var(--white);Â 
Â  Â  Â  Â  Â  Â  padding: 0 15px 0 20px;Â 
Â  Â  Â  Â  Â  Â  height: 60px;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  position: sticky;Â 
Â  Â  Â  Â  Â  Â  top: 0;Â 
Â  Â  Â  Â  Â  Â  z-index: 1000;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 10px rgba(0,0,0,0.1);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .header-logo {
Â  Â  Â  Â  Â  Â  font-weight: 900;
Â  Â  Â  Â  Â  Â  font-size: 1.15rem;
Â  Â  Â  Â  Â  Â  letter-spacing: 1.5px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, #fff, var(--accent), #fff);
Â  Â  Â  Â  Â  Â  background-size: 200% auto;
Â  Â  Â  Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  Â  Â  Â  animation: shine 3s linear infinite, logo-float 2s ease-in-out infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  .header-logo::before {
Â  Â  Â  Â  Â  Â  content: "ğŸ";
Â  Â  Â  Â  Â  Â  -webkit-text-fill-color: initial;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  font-size: 1.3rem;
Â  Â  Â  Â  Â  Â  animation: ball-wiggle 2s infinite ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes shine { to { background-position: 200% center; } }
Â  Â  Â  Â  @keyframes logo-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
Â  Â  Â  Â  @keyframes ball-wiggle { 0%, 100% { transform: rotate(-15deg); } 50% { transform: rotate(15deg) scale(1.1); } }

Â  Â  Â  Â  /* æ–°å¢ï¼šæŠ•ç¥¨å…ƒä»¶æ¨£å¼ */
Â  Â  Â  Â  .badge-vote { background: var(--vote-bg); color: var(--vote-text); padding: 4px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 800; display: inline-block; margin-bottom: 10px; }
Â  Â  Â  Â  .poll-option { margin-top: 10px; cursor: pointer; position: relative; }
Â  Â  Â  Â  .poll-bar-bg { background: #edf2f7; height: 40px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; position: relative; }
Â  Â  Â  Â  .poll-bar-fill { background: var(--accent); height: 100%; transition: width 0.6s ease; opacity: 0.4; }
Â  Â  Â  Â  .poll-text { position: absolute; inset: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-weight: 700; font-size: 0.9rem; }

Â  Â  Â  Â  .menu-btn {
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.1); border: none; color: white;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.3rem; cursor: pointer; width: 40px; height: 40px;
Â  Â  Â  Â  Â  Â  border-radius: 10px; display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .drawer-overlay {
Â  Â  Â  Â  Â  Â  position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
Â  Â  Â  Â  Â  Â  display: none; opacity: 0; transition: 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .drawer-overlay.open { display: block; opacity: 1; }
Â  Â  Â  Â  .drawer {
Â  Â  Â  Â  Â  Â  position: fixed; top: 0; right: -280px; width: 280px; height: 100%;
Â  Â  Â  Â  Â  Â  background: var(--white); z-index: 2001;Â 
Â  Â  Â  Â  Â  Â  box-shadow: -5px 0 25px rgba(0,0,0,0.15);
Â  Â  Â  Â  Â  Â  transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
Â  Â  Â  Â  Â  Â  padding: 25px 20px; display: flex; flex-direction: column;
Â  Â  Â  Â  }
Â  Â  Â  Â  .drawer.open { right: 0; }
Â  Â  Â  Â  .drawer-header {
Â  Â  Â  Â  Â  Â  font-weight: 900; font-size: 1.3rem; margin-bottom: 25px;Â 
Â  Â  Â  Â  Â  Â  display: flex; justify-content: space-between; align-items: center;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid #f1f5f9; padding-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .drawer-item {
Â  Â  Â  Â  Â  Â  padding: 14px 15px; border-radius: 12px; margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer; display: flex; align-items: center; gap: 12px;
Â  Â  Â  Â  Â  Â  font-weight: 700; transition: 0.2s; color: var(--primary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .drawer-item:active { background: #f0f4f8; }

Â  Â  Â  Â  button:disabled {
Â  Â  Â  Â  Â  Â  background-color: var(--gray) !important;
Â  Â  Â  Â  Â  Â  box-shadow: none !important;
Â  Â  Â  Â  Â  Â  transform: none !important;
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-sm { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-left: 5px; }
Â  Â  Â  Â  .app-container { max-width: 900px; margin: 0 auto; padding: 15px; }

Â  Â  Â  Â  @keyframes vball-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
Â  Â  Â  Â  .vball-loader { font-size: 3.5rem; display: inline-block; animation: vball-spin 1.2s infinite cubic-bezier(0.4, 0, 0.2, 1); }
Â  Â  Â  Â  #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .announcement-card { background: #fffaf0; border: 2px solid var(--accent); border-radius: 18px; padding: 18px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(246, 173, 85, 0.1); }
Â  Â  Â  Â  .announcement-header { font-weight: 900; color: #c05621; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .section-title { border-left: 6px solid var(--accent); padding-left: 12px; margin: 30px 0 15px 0; font-size: 1.3rem; font-weight: 900; letter-spacing: 0.5px; }
Â  Â  Â  Â  .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
Â  Â  Â  Â  .card { background: var(--white); border-radius: 24px; padding: 22px; border: 1px solid #edf2f7; box-shadow: 0 6px 15px rgba(0,0,0,0.04); transition: transform 0.2s; }
Â  Â  Â  Â  .card-past { opacity: 0.75; background: #f8fafc; filter: grayscale(0.8); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .card-title { font-size: 1.35rem; font-weight: 800; margin-bottom: 6px; color: var(--primary); letter-spacing: -0.2px; }
Â  Â  Â  Â  .card-date { font-size: 0.9rem; font-weight: 700; color: var(--secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 4px; }
Â  Â  Â  Â  .card-desc { font-size: 0.95rem; color: #4a5568; background: #f8fafc; padding: 12px; border-radius: 14px; margin: 12px 0; border-left: 4px solid var(--accent); white-space: pre-wrap; line-height: 1.6; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .ball-count-badge {
Â  Â  Â  Â  Â  Â  background: #ebf8ff; color: var(--secondary);
Â  Â  Â  Â  Â  Â  padding: 6px 12px; border-radius: 10px; font-size: 0.85rem; font-weight: 800;
Â  Â  Â  Â  Â  Â  display: inline-flex; align-items: center; gap: 6px; margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  border: 1px solid #bee3f8;
Â  Â  Â  Â  }

Â  Â  Â  Â  .reg-area { background: #f1f5f9; border-radius: 14px; padding: 12px; margin: 12px 0; max-height: 160px; overflow-y: auto; font-size: 0.9rem; }
Â  Â  Â  Â  .reg-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-weight: 500; }
Â  Â  Â  Â  .reg-item:last-child { border-bottom: none; }

Â  Â  Â  Â  .btn { width: 100%; padding: 14px; border-radius: 15px; border: none; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
Â  Â  Â  Â  .btn-accent { background: var(--accent); color: var(--primary); box-shadow: 0 4px 0 #d69e2e; margin-bottom: 4px; }
Â  Â  Â  Â  .btn-accent:active { transform: translateY(3px); box-shadow: 0 1px 0 #d69e2e; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .overlay { position: fixed; inset: 0; background: var(--white); z-index: 2000; padding: 25px; display: none; flex-direction: column; overflow-y: auto; }
Â  Â  Â  Â  input, textarea, select { font-family: inherit; width: 100%; padding: 14px; border: 2px solid #edf2f7; border-radius: 12px; margin-bottom: 12px; font-size: 1rem; outline: none; transition: 0.2s; }
Â  Â  Â  Â  input:focus { border-color: var(--accent); background: #fffaf0; }
Â  Â  Â  Â  .admin-label { font-size: 0.85rem; font-weight: 800; color: var(--secondary); margin: 5px 0; display: block; }
Â  Â  Â  Â  .poll-option-clean:active {
Â  Â  Â  Â  Â  Â  background-color: #fffaf0 !important;
Â  Â  Â  Â  Â  Â  border-color: var(--accent) !important;
Â  Â  Â  Â  Â  Â  transform: scale(0.98);
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

<div id="loading-overlay">
Â  Â  <div class="vball-loader">ğŸ</div>
Â  Â  <div id="loading-text" style="margin-top:20px; font-weight:700; color:var(--primary); font-size: 1.1rem; letter-spacing: 2px;">æ­£åœ¨æ’¿çƒä¸­...</div>
</div>

<header>
Â  Â  <div class="header-logo" onclick="location.reload()">TCJH_VOLLEYBALL_TEAM</div>
Â  Â  <button class="menu-btn" onclick="toggleDrawer(true)">â˜°</button>
</header>

<div id="drawer-overlay" class="drawer-overlay" onclick="toggleDrawer(false)"></div>
<div id="drawer" class="drawer">
Â  Â  <div class="drawer-header">
Â  Â  Â  Â  <span>é¸å–®</span>
Â  Â  Â  Â  <button style="background:none; border:none; font-size:1.8rem; cursor:pointer;" onclick="toggleDrawer(false)">Ã—</button>
Â  Â  </div>
Â  Â  <div class="drawer-item" onclick="showInstruction()">ğŸ“– ä½¿ç”¨èªªæ˜</div>
Â  Â  <hr style="width:100%; opacity:0.1; margin: 15px 0;">
Â  Â  <div id="drawer-admin-tools">
Â  Â  Â  Â  <div class="drawer-item" onclick="checkAdmin()">âš™ï¸ ç®¡ç†å“¡ç™»å…¥</div>
Â  Â  </div>
</div>

<div class="app-container">
Â  Â  <div class="announcement-card">
Â  Â  Â  Â  <div class="announcement-header">ğŸ å…¬å‘Šèˆ‡å®ˆå‰‡ ğŸ</div>
Â  Â  Â  Â  <div id="announcement-text" style="font-size:1rem; line-height: 1.6; font-weight: 400;">...</div>
Â  Â  </div>

Â  Â  <div class="section-title" style="border-color: var(--accent);">ğŸ“Š æ„é¡˜èª¿æŸ¥ä¸­</div>
Â  Â  <div id="vote-list" class="event-grid"></div>

Â  Â  <div class="section-title">ğŸ”¥ å³å°‡é€²è¡Œçš„ç·´ç¿’</div>
Â  Â  <div id="event-list" class="event-grid"></div>

Â  Â  <div class="section-title" style="color:var(--gray); border-color:var(--gray); opacity: 0.6;">âŒ› æ­·å²å ´æ¬¡</div>
Â  Â  <div id="past-list" class="event-grid"></div>
</div>

<div id="admin-overlay" class="overlay">
Â  Â  <button class="btn-sm" style="color:var(--primary); width:80px; margin-bottom:20px; border-color: var(--primary); background: #eee;" onclick="closeOverlay()">â† è¿”å›</button>
Â  Â Â 
Â  Â  <h3 style="font-weight:900;">ğŸ“¢ æ›´æ–°å…¬å‘Š</h3>
Â  Â  <textarea id="admin-ann-input" rows="4"></textarea>
Â  Â  <button class="btn btn-accent" style="margin-bottom:20px;" onclick="updateAnn()">ç™¼å¸ƒæ–°å…¬å‘Š</button>
Â  Â Â 
Â  Â  <hr style="opacity:0.1; margin: 20px 0;">
Â  Â Â 
Â  Â  <h3 style="font-weight:900;">ğŸ†• æ–°å¢é …ç›®</h3>
Â  Â  <label class="admin-label">ç™¼å¸ƒæ¨¡å¼</label>
Â  Â  <select id="admin-mode-select" onchange="switchAdminUI()">
Â  Â  Â  Â  <option value="active">ä¸€èˆ¬å ±åæ¨¡å¼</option>
Â  Â  Â  Â  <option value="vote">æŠ•ç¥¨æ„é¡˜æ¨¡å¼</option>
Â  Â  </select>

Â  Â  <label class="admin-label">æ¨™é¡Œ</label>
Â  Â  <input type="text" id="admin-title" placeholder="ä¾‹å¦‚ï¼šé€±æ—¥ç·´ç¿’ / å¯’è¨“æ—¥æœŸèª¿æŸ¥">

Â  Â  <div id="admin-ui-active">
Â  Â  Â  Â  <label class="admin-label">ç·´çƒæ—¥æœŸ</label>
Â  Â  Â  Â  <input type="date" id="admin-date">
Â  Â  Â  Â  <label class="admin-label">äººæ•¸é™åˆ¶</label>
Â  Â  Â  Â  <input type="number" id="admin-max" placeholder="äººæ•¸ä¸Šé™">
Â  Â  Â  Â  <label class="admin-label">å‚™è¨» (å¡«å¯«èœå–®)</label>
Â  Â  Â  Â  <textarea id="admin-desc" rows="3"></textarea>
Â  Â  </div>

<div id="admin-ui-vote" style="display:none;">
Â  Â  <label class="admin-label">æŠ•ç¥¨æˆªæ­¢æ™‚é–“</label>
Â  Â  <input type="datetime-local" id="admin-deadline">
Â  Â Â 
Â  Â  <label class="admin-label">æ­£å¼å ´æ¬¡é è¨ˆäººæ•¸ (é¸å¡«)</label>
Â  Â  <input type="number" id="admin-vote-max" placeholder="ä¾‹å¦‚ï¼š12">

Â  Â  <label class="admin-label">æ³¨æ„äº‹é … / é è¨ˆèª²è¡¨ (åˆ‡æ›å¾Œæœƒä¿ç•™)</label>
Â  Â  <textarea id="admin-vote-desc" rows="3" placeholder="ä¾‹å¦‚ï¼šç•¶å¤©æœƒç·´ç¿’æ””ç¶²ï¼Œè«‹å¸¶ä¹¾æ·¨çƒé‹..."></textarea>

Â  Â  <label class="admin-label">é¸é …æ•¸é‡ (æœ€å¤š10å€‹)</label>
Â  Â  <select id="admin-vote-count" onchange="renderVoteInputs()">
Â  Â  Â  Â  <option value="1">1</option><option value="2">2</option><option value="3">3</option>
Â  Â  Â  Â  <option value="4" selected>4</option><option value="5">5</option><option value="10">10</option>
Â  Â  </select>
Â  Â  <div id="admin-vote-options-area"></div>
Â  Â  </div> <button class="btn btn-accent" style="margin-top:20px; margin-bottom:40px;" onclick="addNewEvent()">ç™¼å¸ƒé …ç›®</button>
</div>

<div id="reg-overlay" class="overlay">
Â  Â  <button class="btn-sm" style="color:var(--primary); width:80px; margin-bottom:20px; border-color: var(--primary); background: #eee;" onclick="closeOverlay()">â† è¿”å›</button>
Â  Â  <h2 id="reg-title" style="font-weight:900;">å ±å</h2>
Â  Â  <input type="hidden" id="reg-event-id">
Â  Â  <input type="text" id="reg-name" placeholder="ä½ çš„å§“å">
Â  Â  <input type="number" id="reg-balls" placeholder="æ”œå¸¶çƒæ•¸">
Â  Â  <textarea id="reg-note" rows="3" placeholder="å‚™è¨»"></textarea>
Â  Â  <button class="btn btn-accent" onclick="submitRegistration()">ç¢ºèªå ±å</button>
</div>

<div id="vote-overlay" class="overlay">
Â  Â  <button class="btn-sm" style="color:var(--primary); width:80px; margin-bottom:20px; border-color: var(--primary); background: #eee;" onclick="closeOverlay()">â† è¿”å›</button>
Â  Â  <h2 id="vote-popup-title" style="font-weight:900;">æŠ•ç¥¨æ„é¡˜</h2>
Â  Â  <p id="vote-popup-choice" style="font-weight:800; color:var(--secondary); font-size:1.1rem;"></p>
Â  Â  <input type="hidden" id="vote-event-id">
Â  Â  <input type="hidden" id="vote-choice-val">
Â  Â  <input type="text" id="vote-user-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
Â  Â  <button class="btn btn-accent" onclick="submitVote()">ç¢ºèªé€å‡º</button>
</div>

<div id="cancel-overlay" class="overlay">
Â  Â  <button class="btn-sm" style="color:var(--primary); width:80px; margin-bottom:20px; border-color: var(--primary); background: #eee;" onclick="closeOverlay()">â† è¿”å›</button>
Â  Â  <h2 style="font-weight:900;">å–æ¶ˆç´€éŒ„</h2>
Â  Â  <p style="font-size:0.95rem; color:var(--danger); font-weight: 500;">* è«‹è¼¸å…¥æ‚¨ç•¶æ™‚ä½¿ç”¨çš„å§“å</p>
Â  Â  <input type="hidden" id="cancel-event-id">
Â  Â  <input type="text" id="cancel-name" placeholder="è«‹è¼¸å…¥å§“å">
Â  Â  <button class="btn" style="background:var(--danger); color:white;" onclick="submitCancel()">ç¢ºèªå–æ¶ˆ</button>
</div>
Â  Â Â 
<div id="cancel-vote-overlay" class="overlay">
Â  Â  <button class="btn-sm" style="color:var(--primary); width:80px; margin-bottom:20px; border-color: var(--primary); background: #eee;" onclick="closeOverlay()">â† è¿”å›</button>
Â  Â  <h2 style="font-weight:900;">æ’¤å›æŠ•ç¥¨æ„é¡˜</h2>
Â  Â  <p style="font-size:0.95rem; color:var(--danger); font-weight: 500;">* è«‹è¼¸å…¥æ‚¨ç•¶æ™‚æŠ•ç¥¨ä½¿ç”¨çš„å§“å</p>
Â  Â  <input type="hidden" id="cancel-vote-event-id">
Â  Â  <input type="hidden" id="cancel-vote-choice">
Â  Â  <input type="text" id="cancel-vote-name" placeholder="è«‹è¼¸å…¥å§“å">
Â  Â  <button class="btn" style="background:var(--danger); color:white;" onclick="submitCancelVote()">ç¢ºèªæ’¤å›</button>
</div>

<script>
Â  Â  const GAS_URL = "https://script.google.com/macros/s/AKfycbyp9nVm07TwfFTA5OQGOD34Ewh9SDQETXs-D1gbESPi2veqCsJ-TDAJaAB0jVpfjGjewA/exec";Â 
Â  Â  let isAdminMode = false;
Â  Â  let currentAdminPwd = sessionStorage.getItem('admin_pwd') || "";

Â  Â  // ç®¡ç†å“¡åˆ‡æ› UI
Â  Â  function switchAdminUI() {
Â  Â  Â  Â  const mode = document.getElementById('admin-mode-select').value;
Â  Â  Â  Â  document.getElementById('admin-ui-active').style.display = (mode === 'active' ? 'block' : 'none');
Â  Â  Â  Â  document.getElementById('admin-ui-vote').style.display = (mode === 'vote' ? 'block' : 'none');
Â  Â  Â  Â  if(mode === 'vote') {
Â  Â  Â  Â  Â  Â  Â  Â  renderVoteInputs();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function renderVoteInputs() {
Â  Â  Â  Â  const count = document.getElementById('admin-vote-count').value;
Â  Â  Â  Â  const area = document.getElementById('admin-vote-options-area');
Â  Â  Â  Â  // å…ˆæ¸…ç©ºä¸¦åŠ ä¸Šæ¨™é¡Œ
Â  Â  Â  Â  area.innerHTML = '<label class="admin-label">é¸é …æ—¥æœŸ (è«‹å¡«å¯«æˆ–é¸æ“‡æ—¥æœŸ)</label>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  for(let i = 0; i < count; i++) {
Â  Â  Â  Â  Â  Â  // é€™è£¡å»ºè­°åŠ ä¸Š type="date" æˆ– type="text"ï¼Œç¢ºä¿æ¨£å¼ä¸€è‡´
Â  Â  Â  Â  Â  Â  area.innerHTML += `<input type="date" class="vote-opt-input" style="margin-bottom: 8px;">`;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function updateAnn() {
Â  Â  Â  Â  const content = document.getElementById('admin-ann-input').value.trim();
Â  Â  Â  Â  if(!content) return alert("è«‹è¼¸å…¥å…¬å‘Šå…§å®¹");
Â  Â  Â  Â Â 
Â  Â  Â  Â  sendData({
Â  Â  Â  Â  Â  Â  type: 'updateAnnouncement', // å°æ‡‰ GAS çš„ case 'updateAnnouncement'
Â  Â  Â  Â  Â  Â  content: content
Â  Â  Â  Â  });
Â  Â  }

Â  Â  async function sendData(payload) {
Â  Â  Â  Â  const loader = document.getElementById('loading-overlay');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  loader.style.display = 'flex';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isAdminMode || payload.type === 'verify') {
Â  Â  Â  Â  Â  Â  Â  Â  payload.adminPassword = currentAdminPwd;
Â  Â  Â  Â  Â  Â  }
Â  Â Â 
Â  Â  Â  Â  Â  Â  // é©—è­‰å¯†ç¢¼æ™‚éœ€è¦å›å‚³å€¼ï¼Œä¸ä½¿ç”¨ no-cors
Â  Â  Â  Â  Â  Â  // ç™¼å¸ƒè³‡æ–™æ™‚è‹¥æ€• CORS å¤±æ•—ï¼Œæ‰è€ƒæ…®åˆ‡æ›æ¨¡å¼
Â  Â  Â  Â  Â  Â  const fetchOptions = {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  };
Â  Â Â 
Â  Â  Â  Â  Â  Â  const res = await fetch(GAS_URL, fetchOptions);
Â  Â  Â  Â  Â  Â  const result = await res.json();
Â  Â Â 
Â  Â  Â  Â  Â  Â  if (result.status === "success") {
Â  Â  Â  Â  Â  Â  Â  Â  if (payload.type === 'verify') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isAdminMode = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('admin_pwd', currentAdminPwd);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateUIForAdmin();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showCreate();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("æ“ä½œæˆåŠŸï¼");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inputs = document.querySelectorAll('input, textarea');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inputs.forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ’é™¤æ‰éš±è—æ¬„ä½èˆ‡ç®¡ç†å¯†ç¢¼ï¼Œå…¶ä»–éƒ½æ¸…ç©º
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (input.type !== 'hidden' && input.id !== 'adminPassword') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ç‰¹åˆ¥é‡è¨­ä¸‹æ‹‰é¸å–® (é¸å›ç¬¬ä¸€å€‹)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const selects = document.querySelectorAll('select');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selects.forEach(s => s.selectedIndex = 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeOverlay();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await fetchData();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert("å¤±æ•—ï¼š" + result.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  // å¦‚æœæ˜¯å› ç‚º CORS å¤±æ•—ï¼Œå˜—è©¦æé†’ä½¿ç”¨è€…
Â  Â  Â  Â  Â  Â  alert("é€£ç·šä¼ºæœå™¨å¤±æ•—ï¼Œè«‹ç¢ºèª GAS éƒ¨ç½²è¨­å®šç‚ºã€Œæ‰€æœ‰äººã€çš†å¯å­˜å–ã€‚");
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  loader.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function fetchData() {
Â  Â  Â  Â  document.getElementById('loading-overlay').style.display = 'flex';
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const resp = await fetch(GAS_URL);
Â  Â  Â  Â  Â  Â  const data = await resp.json();
Â  Â  Â  Â  Â  Â  document.getElementById('announcement-text').innerText = data.announcement;
Â  Â  Â  Â  Â  Â  renderAll(data);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  document.getElementById('loading-overlay').style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function renderAll(data) {
Â  Â  Â  Â  const voteList = document.getElementById('vote-list');
Â  Â  Â  Â  const activeList = document.getElementById('event-list');
Â  Â  Â  Â  const pastList = document.getElementById('past-list');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // åˆå§‹åŒ–æ¸…ç©º
Â  Â  Â  Â  voteList.innerHTML = "";
Â  Â  Â  Â  activeList.innerHTML = "";
Â  Â  Â  Â  pastList.innerHTML = "";
Â  Â Â 
Â  Â  Â  Â  if (!data.events || data.events.length === 0) {
Â  Â  Â  Â  Â  Â  const noDataHtml = "<p style='padding:15px; color:var(--gray); font-weight:500;'>ç›®å‰æš«ç„¡å ´æ¬¡è³‡æ–™</p>";
Â  Â  Â  Â  Â  Â  voteList.innerHTML = noDataHtml;
Â  Â  Â  Â  Â  Â  activeList.innerHTML = noDataHtml;
Â  Â  Â  Â  Â  Â  pastList.innerHTML = noDataHtml;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â Â 
Â  Â  Â  Â  // åˆ†æµè™•ç†
Â  Â  Â  Â  data.events.forEach(ev => {
Â  Â  Â  Â  Â  Â  if (ev.status === 'vote') {
Â  Â  Â  Â  Â  Â  Â  Â  voteList.innerHTML += createVoteCard(ev, data.votes);Â 
Â  Â  Â  Â  Â  Â  } else if (ev.status === 'active') {
Â  Â  Â  Â  Â  Â  Â  Â  activeList.innerHTML += createCard(ev, data.regs, false);
Â  Â  Â  Â  Â  Â  } else if (ev.status === 'archive' || ev.status === 'past') {
Â  Â  Â  Â  Â  Â  Â  Â  pastList.innerHTML += createCard(ev, data.regs, true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â Â 
Â  Â  Â  Â  // æª¢æŸ¥å„å€å¡Šæ˜¯å¦ç‚ºç©ºï¼Œè‹¥ç‚ºç©ºå‰‡é¡¯ç¤ºæç¤ºå­—çœ¼
Â  Â  Â  Â  const emptyMsg = (text) => `<p style='padding:15px; color:var(--gray); font-weight:500;'>${text}</p>`;
Â  Â Â 
Â  Â  Â  Â  if (voteList.innerHTML === "") voteList.innerHTML = emptyMsg("âœ¨ ç›®å‰æ²’æœ‰æ­£åœ¨é€²è¡Œçš„èª¿æŸ¥");
Â  Â  Â  Â  if (activeList.innerHTML === "") activeList.innerHTML = emptyMsg("ğŸ ç›®å‰æ²’æœ‰å³å°‡é€²è¡Œçš„ç·´ç¿’");
Â  Â  Â  Â  if (pastList.innerHTML === "") pastList.innerHTML = emptyMsg("ğŸ“… ç›®å‰æ²’æœ‰æ­·å²å ´æ¬¡ç´€éŒ„");
Â  Â  }
Â  Â Â 
Â  Â  // 2. ä¿®æ”¹Â  å‡½æ•¸ï¼šä¿®æ­£éæ¿¾é‚è¼¯
Â  Â  function createVoteCard(ev, allVotes) {
Â  Â  Â  Â  const id = String(ev.event_id).trim();
Â  Â  Â  Â  const opts = ev.options ? ev.options.split(',').map(o => o.trim()).filter(o => o !== "") : [];
Â  Â  Â  Â  const safeVotes = Array.isArray(allVotes) ? allVotes : [];
Â  Â  Â  Â  const evVotes = safeVotes.filter(v => String(v[0]).trim() === id);
Â  Â  Â  Â  const d = new Date(ev.date);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // æ–°å¢é€™è¡Œï¼šåˆ¤æ–·æŠ•ç¥¨æ˜¯å¦éæœŸ (æˆªæ­¢æ™‚é–“å°æ–¼ç¾åœ¨æ™‚é–“)
Â  Â  Â  Â  const isPast = d < new Date();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const formattedDeadline = `${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
Â  Â Â 
Â  Â  Â  Â  const maxVoteInfo = ev.max > 0 ? ` (é è¨ˆå¾µæ±‚ ${ev.max} äºº)` : "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  let html = `
Â  Â  Â  Â  Â  Â  <div class="card" style="border: 2px solid var(--accent); position: relative; padding: 22px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="badge-vote">ğŸ—³ï¸ æ„é¡˜èª¿æŸ¥ä¸­</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title">${ev.title}${maxVoteInfo}</div>Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div style="color: var(--danger); font-size: 0.85rem; font-weight: 700; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â±ï¸ æˆªæ­¢æ™‚é–“ï¼š${formattedDeadline}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; gap: 10px; margin-bottom: 20px;">`;
Â  Â Â 
Â  Â  Â  Â  opts.forEach(opt => {
Â  Â  Â  Â  Â  Â  const targetOption = String(opt).trim();
Â  Â  Â  Â  Â  Â  const voters = evVotes.filter(v => String(v[2]).trim() === targetOption || String(v[2]).trim().includes(targetOption)).map(v => String(v[1]).trim());
Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="poll-option-item" onclick="handleVoteClick('${id}', '${ev.title}', '${opt}')"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="background:#fff; border: 1.5px solid #e2e8f0; border-radius:12px; padding:12px; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:800; color:var(--primary); font-size:0.95rem; margin-bottom:8px; display:flex; justify-content:space-between;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ“… ${opt}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:var(--secondary); font-size:0.8rem;">${voters.length} äºº</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; flex-wrap:wrap; gap:6px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${voters.length > 0 ? voters.map(name => `<span style="background:#ebf8ff; color:var(--secondary); padding:2px 10px; border-radius:6px; font-size:0.75rem; font-weight:700; border: 1px solid #bee3f8;">${name}</span>`).join('') : '<span style="color:#cbd5e0; font-size:0.75rem;">é»æ“Šåƒèˆ‡æŠ•ç¥¨</span>'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  });
Â  Â Â 
Â  Â  Â  Â  html += `</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-actions" style="display:flex; flex-direction:column; gap:8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" style="background:#f1f5f9; color:var(--gray); font-size:0.9rem;" onclick="openCancelVote('${id}')">æ’¤å›æˆ‘çš„æŠ•ç¥¨</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isAdminMode ? `<button class="btn" style="background:#fff; color:var(--danger); border:1.5px solid #fed7d7; font-size:0.9rem; margin-top:5px;" onclick="deleteEvent('${id}')">ğŸ—‘ï¸ åˆªé™¤æ­¤æŠ•ç¥¨</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isAdminMode && !isPast ? `<button class="btn" style="background:#edf2f7; color:var(--primary); border:1.5px solid #cbd5e0; font-size:0.9rem;" onclick="archiveEvent('${id}')">ğŸ“¦ å­˜æª”æ­¤å ´æ¬¡</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  return html;
Â  Â  }
Â  Â Â 
Â  Â  // æŠ•ç¥¨é»æ“Šè§¸ç™¼
Â  Â  function handleVoteClick(id, title, choice) {
Â  Â  Â  Â  // é–‹å•Ÿä½ å·²ç¶“å¯«å¥½çš„ vote-overlay
Â  Â  Â  Â  openVote(id, title, choice);
Â  Â  }
Â  Â Â 
Â  Â  // 3. ä¿®æ”¹å ±åå¡ç‰‡å‡½æ•¸ (å°æ‡‰ç‰©ä»¶æ ¼å¼)
Â  Â  function createCard(ev, allRegs, isPast) {
Â  Â  Â  Â  const id = ev.event_id;
Â  Â  Â  Â  const eventRegs = allRegs ? allRegs.filter(r => String(r[0]) === String(id)) : [];
Â  Â  Â  Â  const count = eventRegs.length;
Â  Â  Â  Â  const totalBalls = eventRegs.reduce((sum, r) => sum + (parseInt(r[2]) || 0), 0);
Â  Â  Â  Â  const progress = Math.min((count / ev.max) * 100, 100);
Â  Â  Â  Â  const formattedDate = new Date(ev.date).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit', weekday: 'short' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="card ${isPast ? 'card-past' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title">${ev.title}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-date">ğŸ“… ${formattedDate}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-desc">${ev.desc}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.85rem; font-weight:700; display:flex; justify-content:space-between; margin-bottom:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>å ±åé€²åº¦</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${count} / ${ev.max} äºº</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background:#edf2f7; height:10px; border-radius:5px; margin-bottom:10px; overflow:hidden;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="width:${progress}%; height:100%; background:${count>=ev.max?'var(--danger)':'var(--secondary)'}; transition:width 0.8s ease-out;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ball-count-badge">ğŸ ç•¶å‰å…¨éšŠç¸½çƒæ•¸ï¼š${totalBalls}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="reg-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${eventRegs.map(r => `<div class="reg-item"><span>ğŸ‘¤ ${r[1]}</span><span style="color:var(--secondary);">${r[2]} çƒ</span></div>`).join('') || '<div style="text-align:center; color:var(--gray); padding:10px;">å°šæœªæœ‰äººå ±å</div>'}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-actions" style="display:flex; flex-direction:column; gap:8px; margin-top:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isPast ? '' : `<button class="btn btn-accent" onclick="openReg('${id}', '${ev.title}')">ç«‹å³å ±å</button>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${!isPast ? `<button class="btn" style="background:#f1f5f9; color:var(--gray); font-size:0.9rem;" onclick="openCancel('${id}')">å–æ¶ˆæˆ‘çš„å ±å</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isAdminMode ? `<button class="btn" style="background:#fff; color:var(--danger); border:1.5px solid #fed7d7; font-size:0.9rem; margin-top:5px;" onclick="deleteEvent('${id}')">ğŸ—‘ï¸ åˆªé™¤æ­¤å ´æ¬¡</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  }

Â  Â  function openVote(id, title, choice) {
Â  Â  Â  Â  document.getElementById('vote-event-id').value = id;
Â  Â  Â  Â  document.getElementById('vote-choice-val').value = choice;
Â  Â  Â  Â  document.getElementById('vote-popup-title').innerText = "æŠ•ç¥¨æ„é¡˜èª¿æŸ¥";
Â  Â  Â  Â  document.getElementById('vote-popup-choice').innerText = `ã€${title}ã€‘\næ‚¨çš„é¸æ“‡ï¼š${choice}`;
Â  Â  Â  Â  document.getElementById('vote-overlay').style.display = 'flex';
Â  Â  }

Â  Â  function submitVote() {
Â  Â  Â  Â  const name = document.getElementById('vote-user-name').value.trim();
Â  Â  Â  Â  if(!name) return alert("è«‹è¼¸å…¥å§“å");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // é–å®šæŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
Â  Â  Â  Â  const btn = document.querySelector('#vote-overlay .btn-accent');
Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  btn.innerText = "å‚³é€ä¸­...";
Â  Â Â 
Â  Â  Â  Â  sendData({
Â  Â  Â  Â  Â  Â  type: 'vote',
Â  Â  Â  Â  Â  Â  event_id: document.getElementById('vote-event-id').value,
Â  Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  Â  choice: document.getElementById('vote-choice-val').value
Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  // é‡ç½® UI
Â  Â  Â  Â  Â  Â  document.getElementById('vote-user-name').value = "";
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  btn.innerText = "ç¢ºèªé€å‡º";
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function addNewEvent() {
Â  Â  Â  Â  const mode = document.getElementById('admin-mode-select').value;
Â  Â  Â  Â  const title = document.getElementById('admin-title').value.trim();
Â  Â  Â  Â  if(!title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");
Â  Â Â 
Â  Â  Â  Â  let maxVal = parseInt(document.getElementById(mode === 'active' ? 'admin-max' : 'admin-vote-max').value) || 0;
Â  Â  Â  Â  let dateVal = document.getElementById(mode === 'active' ? 'admin-date' : 'admin-deadline').value;
Â  Â  Â  Â  let descVal = document.getElementById(mode === 'active' ? 'admin-desc' : 'admin-vote-desc').value;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // é—œéµä¿®æ­£ï¼šæŠ•ç¥¨é¸é …æ˜¯å­˜åœ¨ options æ¬„ä½ï¼Œè€Œä¸æ˜¯ desc
Â  Â  Â  Â  let optionsVal = "";
Â  Â  Â  Â  if (mode === 'vote') {
Â  Â  Â  Â  Â  Â  optionsVal = Array.from(document.querySelectorAll('.vote-opt-input'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(i => i.value).filter(v => v).join(',');
Â  Â  Â  Â  Â  Â  if(!optionsVal) return alert("è«‹å¡«å¯«æŠ•ç¥¨é¸é …");
Â  Â  Â  Â  }
Â  Â Â 
Â  Â  Â  Â  if(!dateVal) return alert("è«‹å¡«å¯«æ—¥æœŸ/æˆªæ­¢æ™‚é–“");
Â  Â Â 
Â  Â  Â  Â  sendData({
Â  Â  Â  Â  Â  Â  type: 'createEvent',
Â  Â  Â  Â  Â  Â  event_id: 'E' + Date.now(),
Â  Â  Â  Â  Â  Â  title: title,
Â  Â  Â  Â  Â  Â  date: dateVal,
Â  Â  Â  Â  Â  Â  max: maxVal,
Â  Â  Â  Â  Â  Â  desc: descVal,Â  Â  Â 
Â  Â  Â  Â  Â  Â  options: optionsVal, // ç¢ºä¿é€™è¡Œæœ‰å‚³é€åˆ°å¾Œç«¯
Â  Â  Â  Â  Â  Â  status: mode
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- ä»¥ä¸‹ç‚ºåŸæœ¬åŠŸèƒ½é‚è¼¯ (ä¿æŒä¸å‹•) ---
Â  Â  function toggleDrawer(open) { document.getElementById('drawer').classList.toggle('open', open); document.getElementById('drawer-overlay').classList.toggle('open', open); }
Â  Â  function showInstruction() { toggleDrawer(false); alert("ã€ä½¿ç”¨èªªæ˜ã€‘\n1. é»æ“Šã€Œç«‹å³å ±åã€å¡«å¯«è³‡æ–™ã€‚\n2. é»æ“ŠæŠ•ç¥¨é …ç›®çš„ã€Œé€²åº¦æ¢ã€å³å¯åƒèˆ‡æŠ•ç¥¨ã€‚\n3. è‹¥éœ€å–æ¶ˆï¼Œè«‹é»æ“Šå ´æ¬¡ä¸‹æ–¹çš„å–æ¶ˆé€£çµã€‚"); }
Â  Â  function checkAdmin() { toggleDrawer(false); if(isAdminMode) return showCreate(); const p = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼"); if(p) { currentAdminPwd = p; sendData({type:'verify'}); } }
Â  Â  function updateUIForAdmin() { document.getElementById('drawer-admin-tools').innerHTML = `<div class="drawer-item" onclick="showCreate()" style="background:#fff5f5; color:var(--danger);">âš’ï¸ é€²å…¥ç®¡ç†æ¨¡å¼</div><div class="drawer-item" onclick="logout()">ğŸšª ç™»å‡ºç®¡ç†å“¡</div>`; }
Â  Â  function logout() { sessionStorage.removeItem('admin_pwd'); location.reload(); }
Â  Â  function showCreate() { toggleDrawer(false); document.getElementById('admin-overlay').style.display = 'flex'; switchAdminUI(); }// æ‰“é–‹æ™‚å…ˆåŸ·è¡Œä¸€æ¬¡åˆ‡æ› UI çš„é‚è¼¯ï¼Œç¢ºä¿è¼¸å…¥æ¡†è¢«ç•«å‡ºä¾†
Â  Â  function closeOverlay() { document.querySelectorAll('.overlay').forEach(e => e.style.display = 'none'); }
Â  Â  function openReg(id, title) { document.getElementById('reg-overlay').style.display = 'flex'; document.getElementById('reg-event-id').value = id; document.getElementById('reg-title').innerText = 'å ±åï¼š' + title; }
Â  Â  function openCancel(eventId) { document.getElementById('cancel-overlay').style.display = 'flex'; document.getElementById('cancel-event-id').value = eventId; }
Â  Â  function submitRegistration() {
Â  Â  Â  Â  const name = document.getElementById('reg-name').value.trim();
Â  Â  Â  Â  const balls = document.getElementById('reg-balls').value;
Â  Â  Â  Â  if(!name) return alert("è«‹è¼¸å…¥å§“å");
Â  Â  Â  Â  sendData({Â 
Â  Â  Â  Â  Â  Â  type: 'register',Â 
Â  Â  Â  Â  Â  Â  event_id: document.getElementById('reg-event-id').value, // æ”¹ç‚º event_id
Â  Â  Â  Â  Â  Â  name: name,Â 
Â  Â  Â  Â  Â  Â  balls: parseInt(balls) || 0,Â 
Â  Â  Â  Â  Â  Â  note: document.getElementById('reg-note').valueÂ 
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function submitCancel() {
Â  Â  Â  Â  const name = document.getElementById('cancel-name').value.trim();
Â  Â  Â  Â  const eventId = document.getElementById('cancel-event-id').value; // å–å¾—éš±è—æ¬„ä½å€¼
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!name) return alert("è«‹è¼¸å…¥å ±åå§“å");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // é–å®šæŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
Â  Â  Â  Â  const btn = document.querySelector('#cancel-overlay .btn');
Â  Â  Â  Â  const originalText = btn.innerText;
Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  btn.innerText = "è™•ç†ä¸­...";
Â  Â Â 
Â  Â  Â  Â  sendData({Â 
Â  Â  Â  Â  Â  Â  type: 'cancelRegistration',Â 
Â  Â  Â  Â  Â  Â  event_id: eventId,Â  // ç¢ºä¿æ˜¯ event_id
Â  Â  Â  Â  Â  Â  name: nameÂ 
Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  btn.innerText = originalText;
Â  Â  Â  Â  Â  Â  document.getElementById('cancel-name').value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function deleteEvent(id) {
Â  Â  Â  Â  if(confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿç›¸é—œç´€éŒ„ä¹ŸæœƒåŒæ­¥åˆªé™¤ã€‚")) {Â 
Â  Â  Â  Â  Â  Â  sendData({ type: 'deleteEvent', event_id: id }); // æ”¹ç‚º event_id
Â  Â  Â  Â  }
Â  Â  }

Â  Â  (async () => {
Â  Â  Â  Â  if (currentAdminPwd) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({type:'verify', adminPassword: currentAdminPwd}) });
Â  Â  Â  Â  Â  Â  Â  Â  const r = await res.json();Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (r.status === "success") { isAdminMode = true; updateUIForAdmin(); }
Â  Â  Â  Â  Â  Â  } catch(e) {}
Â  Â  Â  Â  }
Â  Â  Â  Â  fetchData();
Â  Â  })();
Â  Â Â 
Â  Â  function openCancelVote(eventId) {
Â  Â  Â  Â  document.getElementById('cancel-vote-overlay').style.display = 'flex';
Â  Â  Â  Â  document.getElementById('cancel-vote-event-id').value = eventId;
Â  Â  }
Â  Â Â 
Â  Â  function submitCancelVote() {
Â  Â  Â  Â  const name = document.getElementById('cancel-vote-name').value.trim();
Â  Â  Â  Â  const eventId = document.getElementById('cancel-vote-event-id').value;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!name) return alert("è«‹è¼¸å…¥å§“å");
Â  Â  Â  Â Â 
Â  Â  Â  Â  const btn = document.querySelector('#cancel-vote-overlay .btn');
Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  btn.innerText = "æ’¤å›ä¸­...";
Â  Â Â 
Â  Â  Â  Â  sendData({Â 
Â  Â  Â  Â  Â  Â  type: 'cancelVote', // å°æ‡‰ GAS å¾Œç«¯çš„å‹•ä½œ
Â  Â  Â  Â  Â  Â  event_id: eventId,
Â  Â  Â  Â  Â  Â  name: nameÂ 
Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  btn.innerText = "ç¢ºèªæ’¤å›";
Â  Â  Â  Â  Â  Â  document.getElementById('cancel-vote-name').value = "";
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function archiveEvent(id) {
Â  Â  Â  Â  if(confirm("ç¢ºå®šè¦å°‡æ­¤å ´æ¬¡å­˜å…¥æ­·å²ç´€éŒ„å—ï¼Ÿå­˜æª”å¾Œå°‡ç„¡æ³•å†å ±åã€‚")) {
Â  Â  Â  Â  Â  Â  sendData({
Â  Â  Â  Â  Â  Â  Â  Â  type: 'archiveEvent',
Â  Â  Â  Â  Â  Â  Â  Â  event_id: id
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }
</script>
</body>
</html>
