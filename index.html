<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCJH Volleyball Team</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #1a365d; --secondary: #2b6cb0; --accent: #f6ad55;
            --danger: #e53e3e; --bg: #f7fafc; --white: #ffffff; --gray: #718096;
            --vote-bg: #feebc8; --vote-text: #9c4221;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; color: var(--primary);
            -webkit-font-smoothing: antialiased;
        }
    
        /* --- æ‰¾å›å¤±è¹¤çš„å‹•ç•«æ¨™é ­ --- */
        header { 
            background: var(--primary); color: var(--white); padding: 0 15px 0 20px; 
            height: 60px; display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
    
        .header-logo {
            font-weight: 900; font-size: 1.15rem; letter-spacing: 1.5px; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            background: linear-gradient(90deg, #fff, var(--accent), #fff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite, logo-float 2s ease-in-out infinite;
        }
    
        .header-logo::before {
            content: "ğŸ"; -webkit-text-fill-color: initial;
            display: inline-block; font-size: 1.3rem;
            animation: ball-wiggle 2s infinite ease-in-out;
        }
    
        /* å‹•æ…‹å®šç¾© */
        @keyframes shine { to { background-position: 200% center; } }
        @keyframes logo-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        @keyframes ball-wiggle { 0%, 100% { transform: rotate(-15deg); } 50% { transform: rotate(15deg) scale(1.1); } }
        
        /* è¼‰å…¥å‹•ç•« */
        @keyframes vball-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .vball-loader { font-size: 3.5rem; display: inline-block; animation: vball-spin 1.2s infinite cubic-bezier(0.4, 0, 0.2, 1); }
    
        /* --- å…¶ä»–åŠŸèƒ½æ¨£å¼ --- */
        .app-container { max-width: 900px; margin: 0 auto; padding: 15px; }
        .section-title { border-left: 6px solid var(--accent); padding-left: 12px; margin: 30px 0 15px 0; font-size: 1.3rem; font-weight: 900; }
        
        .card { background: var(--white); border-radius: 24px; padding: 22px; margin-bottom: 20px; border: 1px solid #edf2f7; box-shadow: 0 6px 15px rgba(0,0,0,0.04); position: relative; }
        .badge { position: absolute; top: 20px; right: 20px; padding: 4px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 800; }
        .badge-vote { background: var(--vote-bg); color: var(--vote-text); }
        
        .poll-option { margin-top: 12px; cursor: pointer; position: relative; }
        .poll-bar-bg { background: #edf2f7; height: 40px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; position: relative; }
        .poll-bar-fill { background: var(--accent); height: 100%; transition: width 0.6s ease; opacity: 0.3; }
        .poll-text { position: absolute; inset: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-weight: 700; font-size: 0.9rem; }
        
        .poll-option:hover::after {
            content: attr(data-voters);
            position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white; padding: 8px 12px; border-radius: 8px;
            font-size: 0.8rem; white-space: pre-wrap; z-index: 100; min-width: 100px;
            display: var(--tooltip-display, none);
        }
        .poll-option:hover { --tooltip-display: block; }
    
        .btn { width: 100%; padding: 14px; border-radius: 15px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; transition: 0.2s; margin-top: 10px; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-accent { background: var(--accent); color: var(--primary); }
        .btn-outline { background: none; border: 2px solid #edf2f7; color: var(--gray); font-size: 0.85rem; }
        .btn-admin { background: #fdf2f2; border: 1px solid #feb2b2; color: #c53030; }
    
        .overlay { position: fixed; inset: 0; background: var(--white); z-index: 2000; padding: 25px; display: none; flex-direction: column; overflow-y: auto; }
        input, textarea, select { padding: 14px; border: 2px solid #edf2f7; border-radius: 12px; margin-bottom: 12px; font-size: 1rem; width: 100%; outline-color: var(--accent); }
    
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="vball-loader">ğŸ</div>
    <div style="margin-top:20px; font-weight:700; color:var(--primary); letter-spacing: 2px;">æ­£åœ¨æ’¿çƒä¸­...</div>
</div>
  
<header>
    <div class="header-logo" onclick="location.reload()">ğŸ TCJH TEAM</div>
    <button style="background:none; border:none; color:white; font-size:1.5rem;" onclick="openAdmin()">âš™ï¸</button>
</header>

<div class="app-container">
    <div id="vote-section"></div>
    <div id="active-section"></div>
    <div id="past-section"></div>
</div>

<div id="vote-overlay" class="overlay">
    <button class="btn-outline" style="width:80px" onclick="closeOverlay()">â† è¿”å›</button>
    <h2 id="vote-target-title" style="margin-top:20px;">ç¢ºèªæŠ•ç¥¨</h2>
    <p id="vote-target-choice" style="font-weight:700; color:var(--secondary); font-size:1.2rem;"></p>
    <input type="text" id="vote-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å (è¨˜åæŠ•ç¥¨)">
    <button class="btn btn-accent" onclick="submitVote()">é€å‡ºæŠ•ç¥¨</button>
</div>

<div id="reg-overlay" class="overlay">
    <button class="btn-outline" style="width:80px" onclick="closeOverlay()">â† è¿”å›</button>
    <h2 id="reg-title" style="margin-top:20px;">å ±åå ´æ¬¡</h2>
    <input type="hidden" id="reg-event-id">
    <input type="text" id="reg-name" placeholder="å§“å">
    <input type="number" id="reg-balls" placeholder="æ”œå¸¶çƒæ•¸">
    <textarea id="reg-note" placeholder="å‚™è¨»"></textarea>
    <button class="btn btn-accent" onclick="submitRegistration()">ç¢ºèªå ±å</button>
</div>

<div id="admin-overlay" class="overlay">
    <button class="btn-outline" style="width:80px" onclick="closeOverlay()">â† è¿”å›</button>
    <h3 style="margin-top:20px;">ğŸ› ï¸ ç®¡ç†æ§åˆ¶å°</h3>
    <label>ç™¼å¸ƒé¡å‹</label>
    <select id="admin-status">
        <option value="vote">æŠ•ç¥¨æ¨¡å¼ (èªªæ˜æ¬„è«‹å¡«å¯«é¸é …ï¼Œç”¨é€—è™Ÿéš”é–‹)</option>
        <option value="active">å ±åæ¨¡å¼</option>
    </select>
    <input type="text" id="admin-title" placeholder="æ¨™é¡Œ (ä¾‹å¦‚ï¼šä¸‹é€±ç·´ç¿’æ™‚é–“æŠ•ç¥¨)">
    <input type="date" id="admin-date">
    <input type="number" id="admin-max" placeholder="äººæ•¸ä¸Šé™ (æŠ•ç¥¨æ¨¡å¼å¯å¡«0)">
    <textarea id="admin-desc" placeholder="èªªæ˜æˆ–æŠ•ç¥¨é¸é … (ä¾‹: é€±äºŒ,é€±ä¸‰,é€±å››)"></textarea>
    <button class="btn btn-accent" onclick="addNewEvent()">ç™¼å¸ƒé …ç›®</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyp9nVm07TwfFTA5OQGOD34Ewh9SDQETXs-D1gbESPi2veqCsJ-TDAJaAB0jVpfjGjewA/exec";
    let allData = {};
    let isAdmin = sessionStorage.getItem('isAdmin') === 'true';

    async function fetchData() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const res = await fetch(GAS_URL);
            allData = await res.json();
            render();
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    function render() {
        const vArea = document.getElementById('vote-section');
        const aArea = document.getElementById('active-section');
        
        vArea.innerHTML = '';
        aArea.innerHTML = '<div class="section-title">ğŸ”¥ å³å°‡é€²è¡Œçš„ç·´ç¿’</div>';

        const votes = allData.events.filter(e => e.status === 'vote');
        const actives = allData.events.filter(e => e.status === 'active');

        if(votes.length > 0) {
            vArea.innerHTML = '<div class="section-title">ğŸ—³ï¸ æŠ•ç¥¨ä¸­</div>';
            votes.forEach(ev => vArea.appendChild(createVoteCard(ev)));
        }

        actives.forEach(ev => aArea.appendChild(createActiveCard(ev)));
    }

    function createVoteCard(ev) {
        const div = document.createElement('div');
        div.className = 'card';
        const options = ev.desc.split(',').map(s => s.trim());
        const evVotes = allData.votes.filter(v => v[0] === ev.event_id);
        
        div.innerHTML = `<div class="badge badge-vote">æŠ•ç¥¨ä¸­</div><div class="card-title">${ev.title}</div>`;
        
        options.forEach(opt => {
            const voters = evVotes.filter(v => v[2] === opt).map(v => v[1]);
            const percent = evVotes.length ? (voters.length / evVotes.length * 100) : 0;
            
            const optDiv = document.createElement('div');
            optDiv.className = 'poll-option';
            optDiv.setAttribute('data-voters', voters.length ? `å·²æŠ• (${voters.length}äºº):\n${voters.join(', ')}` : "æš«ç„¡äººæŠ•ç¥¨");
            optDiv.onclick = () => openVote(ev.event_id, ev.title, opt);
            optDiv.innerHTML = `
                <div class="poll-bar-bg">
                    <div class="poll-bar-fill" style="width:${percent}%"></div>
                    <div class="poll-text"><span>${opt}</span><span>${voters.length} ç¥¨</span></div>
                </div>`;
            div.appendChild(optDiv);
        });

        if (isAdmin) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-admin';
            btn.innerText = 'çµæŸæŠ•ç¥¨ä¸¦é–‹å•Ÿå ±å';
            btn.onclick = () => convertToActive(ev.event_id);
            div.appendChild(btn);
        }
        return div;
    }

    function createActiveCard(ev) {
        const div = document.createElement('div');
        div.className = 'card';
        const regs = allData.regs.filter(r => r[0] === ev.event_id);
        const totalBalls = regs.reduce((s, r) => s + (parseInt(r[2]) || 0), 0);
        
        div.innerHTML = `
            <div class="card-title">${ev.title}</div>
            <div style="color:var(--secondary); font-weight:700; font-size:0.9rem; margin-bottom:10px;">ğŸ“… ${new Date(ev.date).toLocaleDateString()}</div>
            <div style="background:#f8fafc; padding:12px; border-radius:12px; font-size:0.9rem; margin-bottom:10px;">${ev.desc}</div>
            <div style="display:flex; justify-content:space-between; font-size:0.85rem; font-weight:700; margin-bottom:5px;">
                <span>å ±åäººæ•¸: ${regs.length} / ${ev.max}</span>
                <span>ğŸ ç¸½çƒæ•¸: ${totalBalls}</span>
            </div>
            <button class="btn btn-accent" onclick="openReg('${ev.event_id}', '${ev.title}')">ç«‹å³å ±å</button>
        `;
        
        if(isAdmin) {
            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-outline';
            delBtn.innerText = 'ğŸ—‘ï¸ çµæŸä¸¦å°å­˜æ­¤å ´æ¬¡';
            delBtn.onclick = () => archiveEvent(ev.event_id);
            div.appendChild(delBtn);
        }
        return div;
    }

    // å½ˆçª—é‚è¼¯
    function openVote(id, title, choice) {
        window.currentVoteTask = { id, choice };
        document.getElementById('vote-target-title').innerText = title;
        document.getElementById('vote-target-choice').innerText = "æ‚¨çš„é¸æ“‡ï¼š" + choice;
        document.getElementById('vote-overlay').style.display = 'flex';
    }

    function openReg(id, title) {
        document.getElementById('reg-event-id').value = id;
        document.getElementById('reg-title').innerText = "å ±åï¼š" + title;
        document.getElementById('reg-overlay').style.display = 'flex';
    }

    function openAdmin() {
        if(!isAdmin) {
            const p = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼");
            if(p) {
                window.adminPwd = p;
                sendData({type:'verify', adminPassword:p});
            }
        } else {
            document.getElementById('admin-overlay').style.display = 'flex';
        }
    }

    function closeOverlay() { document.querySelectorAll('.overlay').forEach(el => el.style.display = 'none'); }

    // API å‘¼å«
    async function sendData(payload) {
        document.getElementById('loading-overlay').style.display = 'flex';
        if(isAdmin || payload.type === 'verify') payload.adminPassword = window.adminPwd || sessionStorage.getItem('pwd');
        
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            if(result.status === 'success') {
                if(payload.type === 'verify') {
                    isAdmin = true;
                    sessionStorage.setItem('isAdmin', 'true');
                    sessionStorage.setItem('pwd', payload.adminPassword);
                    alert("é©—è­‰æˆåŠŸ");
                }
                closeOverlay();
                await fetchData();
            } else {
                alert(result.message);
            }
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    function submitVote() {
        const name = document.getElementById('vote-name').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        sendData({ type: 'vote', event_id: window.currentVoteTask.id, name, choice: window.currentVoteTask.choice });
    }

    function submitRegistration() {
        const name = document.getElementById('reg-name').value.trim();
        const balls = document.getElementById('reg-balls').value;
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        sendData({ 
            type: 'register', 
            event_id: document.getElementById('reg-event-id').value, 
            name, balls, note: document.getElementById('reg-note').value 
        });
    }

    function addNewEvent() {
        sendData({
            type: 'createEvent',
            event_id: 'E' + Date.now(),
            status: document.getElementById('admin-status').value,
            title: document.getElementById('admin-title').value,
            date: document.getElementById('admin-date').value,
            max: document.getElementById('admin-max').value,
            desc: document.getElementById('admin-desc').value
        });
    }

    function convertToActive(id) {
        const newTitle = prompt("æŠ•ç¥¨çµæŸï¼Œè«‹è¼¸å…¥ç¢ºå®šçš„å ´æ¬¡åç¨±/æ—¥æœŸ (ä¾‹å¦‚: 2/10 è‡ªç”±ç·´ç¿’)");
        if(newTitle) sendData({ type: 'convertToActive', event_id: id, newTitle });
    }

    function archiveEvent(id) {
        if(confirm("ç¢ºå®šè¦çµæŸä¸¦å°å­˜æ­¤å ´æ¬¡å—ï¼Ÿ")) sendData({ type: 'archiveEvent', event_id: id });
    }

    fetchData();
</script>
</body>
</html>
